# PostgreSQL論理レプリケーション概要

## 論理レプリケーションとは

PostgreSQLの論理レプリケーションは、テーブル単位でデータの複製を行う仕組みです。データベースの変更（INSERT、UPDATE、DELETE操作）をトランザクションログ（WAL）から抽出し、それを論理的な変更セットとして変換してから送信します。これにより、異なるメジャーバージョン間でのレプリケーションや、特定のテーブルのみの複製が可能になります。

## 物理レプリケーションとの違い

| 特徴 | 論理レプリケーション | 物理レプリケーション |
|------|-------------------|-------------------|
| 複製対象 | テーブル単位で選択可能 | データベース全体 |
| バージョン互換性 | 異なるメジャーバージョン間で可能 | 同じメジャーバージョンが必要 |
| 構造変更 | ソースとレプリカで独立した構造変更可能 | レプリカはソースと同一構造が必要 |
| 実装方法 | パブリケーション/サブスクリプションモデル | ストリーミングレプリケーション/WALシッピング |
| リソース消費 | CPU使用率が比較的高い | ディスクI/Oがボトルネックになりがち |
| スケーラビリティ | きめ細かな制御が可能 | シンプルだがやや硬直的 |

## 論理レプリケーションの仕組み

![論理レプリケーションの仕組み](https://www.postgresql.org/docs/current/images/logical-replication-architecture.svg)

1. **パブリッシャー（ソース）**: 
   - WALからデータ変更を抽出
   - 各テーブルの変更を論理的な変更レコードに変換
   - 変更セットをサブスクライバーに送信

2. **サブスクライバー（レプリカ）**:
   - 変更セットを受信
   - ローカルデータベースに適用
   - ソースとは独立して動作

3. **主要コンポーネント**:
   - `wal_level = logical`: 論理デコーディング情報をWALに含める設定
   - レプリケーションスロット: 未送信のWALを追跡
   - パブリケーション: レプリケーション対象テーブルの論理グループ
   - サブスクリプション: パブリケーションの購読を管理

## 論理レプリケーションの利点

1. **柔軟性**:
   - 特定のテーブルのみを選択的に複製できる
   - 複数のソースからデータを統合できる
   - 異なるバージョン間でのレプリケーションが可能

2. **オンライン移行**:
   - ダウンタイムを最小限に抑えたデータベース移行
   - バージョンアップグレードの簡易化

3. **分散処理**:
   - 読み取りワークロードの分散
   - 地理的に分散されたレプリカの維持

4. **RDSとの互換性**:
   - オンプレミスからRDSへの移行に適している
   - ハイブリッドクラウド構成の実現

## 論理レプリケーションの欠点

1. **パフォーマンスオーバーヘッド**:
   - 物理レプリケーションよりもCPU使用率が高い
   - 大量のDMLがある環境では遅延が発生する可能性

2. **スキーマの考慮**:
   - テーブルにプライマリキーが必要
   - DDL（スキーマ変更）は自動的に複製されない

3. **制限事項**:
   - 大きなオブジェクト（BLOB/CLOB）の扱いに制限あり
   - シーケンスは複製されない
   - DDL変更の複製には追加対応が必要

4. **初期同期時間**:
   - 大きなテーブルの初期コピーに時間がかかる
   - 大規模データベースでは事前計画が必要

## RDSを使った論理レプリケーションの特徴

### RDSをレプリカとして使う場合のメリット

1. **管理の簡素化**:
   - バックアップ、パッチ適用、高可用性がAWSにより管理
   - モニタリングとアラート設定が容易

2. **スケーラビリティ**:
   - 読み取りレプリカの追加が簡単
   - インスタンスタイプのアップグレードが柔軟

3. **コスト最適化**:
   - オンプレミスからクラウドへの段階的移行
   - リザーブドインスタンスによるコスト削減

### RDSをレプリカとして使う場合の注意点

1. **設定の制限**:
   - 一部のPostgreSQLパラメータが変更できない
   - `rds.logical_replication`パラメータの有効化が必要

2. **ネットワーク考慮事項**:
   - ソースDBからRDSへの安定した接続が必要
   - VPNまたはDirect Connectの検討

3. **セキュリティ設定**:
   - 適切なセキュリティグループの設定
   - SSL接続の検討

## 具体的なユースケース

### 1. データベース移行

オンプレミスからRDSへの段階的移行:
- 初期データをRDSにロード
- 論理レプリケーションを設定して変更を同期
- 検証後に本番トラフィックを切り替え

### 2. リアルタイムデータウェアハウジング

運用データベースから分析用DBへのデータ同期:
- 運用DBの負荷を増やさずにデータを複製
- 特定のテーブルのみを分析用DBに複製
- 分析用のインデックスや集計テーブルを追加

### 3. 災害対策

地理的に分散したレプリカの維持:
- 異なるAWSリージョンにレプリカを配置
- 災害時に迅速にフェイルオーバー
- 定期的なリカバリテストを実施

### 4. シャーディング

大規模データベースの分散管理:
- データをシャード（分割）して複数のDBに分散
- 各シャードのデータを中央レポジトリに集約
- 統合的な分析やレポートを実現

## 設計上のベストプラクティス

1. **テーブル設計**:
   - すべてのテーブルにプライマリキーを設定
   - 大きなBLOB/CLOBフィールドは分離を検討

2. **ネットワーク設計**:
   - 安定した低レイテンシ接続を確保
   - 必要に応じてVPNまたはDirect Connectを使用

3. **監視設計**:
   - レプリケーション遅延を定期的に測定
   - スロットのサイズを監視
   - アラートの設定

4. **バックアッププラン**:
   - レプリケーションはバックアップの代替にならない
   - 定期的なスナップショットを取得
   - リカバリ手順をテスト

## まとめ

PostgreSQLの論理レプリケーションは、特にRDSをレプリカとして使用する場合、柔軟性と管理のしやすさを兼ね備えたソリューションです。適切に設計・実装すれば、高可用性、災害対策、クラウド移行などの様々な要件に対応できます。

ただし、パフォーマンスオーバーヘッドや設定の複雑さなどの欠点も理解しておく必要があります。各ユースケースに応じて物理レプリケーションとの適切な選択を検討し、本番環境への適用前に十分なテストを実施することをお勧めします。

## 参考リンク

- [PostgreSQL公式ドキュメント - 論理レプリケーション](https://www.postgresql.org/docs/current/logical-replication.html)
- [Amazon RDS for PostgreSQLでの論理レプリケーション](https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/CHAP_PostgreSQL.html#PostgreSQL.Concepts.LogicalReplication)
- [PostgreSQL論理レプリケーション - 実践ガイド](https://www.2ndquadrant.com/en/blog/logical-replication-postgresql-10/)